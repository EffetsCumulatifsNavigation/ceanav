#' Identification de la vulnérabilité des composantes valorisées aux stresseurs environnementaux
#'
#' @keywords vulnérabilité
#'
#' @export
#'
#' @details Cette fonction effectue formate la base de donnée de vulnérabilité des composantes valorisées aux stresseurs environnementaux considérés
#'

ana_vulnerability <- function() {
  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #
  # Load data
  # ------------------------------------
  #
  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #

  # ------------------------------------------------------------------------- #}

  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #
  # Combinaisons habitats + mammifères marins / stresseurs
  # NOTE: Les sites n'ont pas de vulnérabilité
  # NOTE: La vulnérabilité des berges à l'érosion est évaluée séparément à
  #       l'aide des travaux de Bernier et al. 2020, 2021
  # ------------------------------------
  #
  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #
  nm <- c("categorie","francais","description")

  # Metadonnées composantes valorisées
  hab <- load_metadata("int_cv_habitat")$dataDescription$categories %>%
         as.data.frame() %>%
         mutate(categorie = "Habitats")

  # -----
  mm <- load_metadata("int_cv_mammiferes_marins")$dataDescription$categories %>%
        as.data.frame() %>%
        rename(description = scientific) %>%
        mutate(categorie = "Mammifères marins")

  # -----
  cv <- bind_rows(hab[, nm], mm[, nm])

  # Métadonnées stresseurs
  ancrage <- load_metadata("int_st_ancrage")$dataDescription$categories %>%
             as.data.frame() %>%
             mutate(description = "",
                    categorie = "Sites d'ancrage")

  deversement <- load_metadata("int_st_deversement")$dataDescription$categories %>%
                 as.data.frame() %>%
                 rename(description = souscategories) %>%
                 mutate(categorie = "Déversements accidentels")

  dragage <- load_metadata("int_st_dragage")$dataDescription$categories %>%
             as.data.frame() %>%
             mutate(description = "",
                    categorie = "Dragage")

  navigation <- load_metadata("int_st_navigation")$dataDescription$categories %>%
                as.data.frame() %>%
                mutate(description = "",
                        categorie = "Navigation")

  peche_commerciale <- load_metadata("int_st_peche_commerciale")$dataDescription$categories %>%
                       as.data.frame() %>%
                       mutate(description = "",
                              categorie = "Pêche commerciale")

  # -----
  st <- bind_rows(ancrage[,nm],
                  deversement[,nm],
                  dragage[,nm],
                  navigation[,nm],
                  peche_commerciale[,nm])

  # Combinaisons
  combinaisons <- expand.grid(st$francais, cv$francais) %>%
                  select(cv = Var2, st = Var1) %>%
                  left_join(cv[, c("categorie","francais")], by = c("cv" = "francais")) %>%
                  rename(cv_cat = categorie) %>%
                  left_join(st[, c("categorie","francais")], by = c("st" = "francais")) %>%
                  rename(st_cat = categorie) %>%
                  arrange(cv_cat, cv) %>%
                  select(cv_cat, cv, st_cat, st)

  # # Export table for external use (to remove eventually)
  # write.csv(combinaisons, "./data/data-output/combinaisons.csv",
  #           row.names = FALSE, fileEncoding = "UTF-8")
  #
  # write.csv(st, "./data/data-output/stresseurs.csv",
  #           row.names = FALSE, fileEncoding = "UTF-8")
  #
  # write.csv(cv, "./data/data-output/composantes_valorisees.csv",
  #           row.names = FALSE, fileEncoding = "UTF-8")
  # ------------------------------------------------------------------------- #

  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #
  # Export data
  # ------------------------------------
  #
  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #
  # -----
  write.csv(vulnerabilite, )
  # ------------------------------------------------------------------------- #}

  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #
  # Clean global environment
  #
  # =~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~=~-~= #
  clean()
  # ------------------------------------------------------------------------- #}
}
